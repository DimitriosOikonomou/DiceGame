<!doctype html>

<!---->
<html lang="el">

  <head>

    <!-- Required meta tags -->

    <meta charset="utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">



    <!-- Bootstrap CSS -->

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>Dice Game</title>

  </head>

  <body>


    <br>

    <form id=bet-form>

      <div class="container-fluid" style="width: 70%; text-align: center; background-image: url('img/casino2.jpg'); 
      height: 100%; background-position: center; background-repeat: no-repeat; background-size: cover; padding: 0%;">

        <div class="form-group" style="backdrop-filter: blur(5px);">

          <div id="title" style="position: relative;">
            <img src="img/rotating-dollar-sign.gif" width="100">
            <span style="font-size: 50px; font-weight: 800; color: green;">Are you ready to gamble?</span>
            <img src="img/rotating-dollar-sign.gif" width="100">
          </div>


          <div id="die-holder" style="position: relative;">
            <img src="img/d10.png">
            <span id="die-value" style="font-size: 55px; color: white; position: absolute; right: 48.5%; top: 15%;"> 7 </span>
          </div>
          <br>

          <h3 style="color: white;">Do you want to bet high or low?</h3>

          <button type="button" class="btn btn-warning btn-lg" id="high-button">High</button>
          &emsp;
          <button type="button" class="btn btn-warning btn-lg" id="low-button">Low</button>

          <br>
          <br>

          <h1 style="color: white;">Bet amount:</h1>
          <input value="" type="text" class="form-control-lg" id="amount" placeholder="ETH" style="width: 10%;">
            
          <br>
          <br>
          <button type="submit" id="roll-button" class="btn btn-warning btn-lg" >Roll!</button>
          <br>
          <textarea id="history-box" class="col-lg-4 col-lg-offset-4" placeholder="" rows="3" readonly="" style="width: 50%; font-weight: 500;">History:</textarea>

        </div>
      </div>
      
  </form>

    <script src="https://unpkg.com/@metamask/legacy-web3@latest/dist/metamask.web3.min.js"></script>
    <script src="contractAbi.js"></script>

    <!-- Optional JavaScript -->

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>



	<script>

		window.addEventListener('load', async () => { 

			// Modern dapp browsers...

			if (window.ethereum) {

				web3 = new Web3(ethereum);

				try {

					// Request account access if needed

					await window.ethereum.enable();
          
          return web3;

				} catch (error) {

					// User denied account access...
          console.error(error);
				}

			}

			// Legacy dapp browsers...

			else if (window.web3) {

        window.web3 = new Web3(web3.currentProvider)

			  console.log('Injected web3 detected.');

        return web3;

			}

			// Non-dapp browsers...

			else {

				console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');

			}

		});

      if ( typeof web3 != 'undefined' ) {

        web3 = new Web3(web3.currentProvider);

      } else {

        web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));

      }

	</script>

	<script>

      //Address of my contract
      var contractAddress = "0x10f34fF79E9C2D5C1793Ca775a222b363E4D82cc";

      var DiceGameContract = new web3.eth.Contract(abi,contractAddress);

      //Keeps track of betting choise (high=true, low=false)
      //Gets changed when high or low buttons are clicked
      var choice;

      var defaultAccount;

      $("#high-button").click(function() {
        //Sets choice to true and changes colors of the buttons
        choice = true;

        //Change color of buttons
        $('#low-button').attr('class', 'btn btn-warning btn-lg');
        $('#high-button').attr('class', 'btn btn-danger btn-lg');
      });

      $("#low-button").click(function() {
        //Inverse of high button
        choice = false;

        $('#high-button').attr('class', 'btn btn-warning btn-lg');
        $('#low-button').attr('class', 'btn btn-danger btn-lg');
      });

      $("#bet-form").submit(function() {

        event.preventDefault();
      
        //Get Default account
        web3.eth.getAccounts().then(accounts => defaultAccount=accounts[0]);
        console.log(defaultAccount);
        
        //Get bet amount
        var amount = $('#amount').val();

        //Call winOrLose method from contract
        DiceGameContract.methods.winOrLose(choice).send(
          {from: defaultAccount, gas: 5000000, value: web3.utils.toWei(amount, "ether")},
            function(error, result) {

              if (error) {
          
                console.log('error: ' + error);

              } else {

                //Wait for result to return
                
                //Set die value
                $("#die-value").text(result[1]);

                if (result[0]==true) {
                  var wonOrLost = "won";
                } else {
                  var wonOrLost = "lost";
                }

                if (choice==true) {
                  var highOrLow = "high";
                } else {
                  var highOrLow = "low";
                }
                
                //Append result to history box
                $("#history-box").append(`\n\nResult:  ${wonOrLost}\nYou ${wonOrLost} 
                  ${amount.toString()} by guessing ${result[1].toString()} would be ${highOrLow}!`);
                $("#history-box").scrollTop($("#history-box").position().top);â€‹
              }
            }
        )


      });


  </script>



    </body>

</html>